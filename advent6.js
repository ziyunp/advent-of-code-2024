// position r, c
// up
//  move straight = r - 1
//  turn right = >
// right
//  move straight = c + 1
//  turn right = down
// down
//  move straight = r + 1
//  turn right = <
// left
//  move straight = c - 1
//  turn right = ^
class Position {
  constructor(r, c, direction) {
    this.r = r;
    this.c = c;
    this.direction = direction;
  }
  isEqual(pos) {
    return pos.r === this.r && pos.c === this.c;
  }
  turnRight() {
    switch (this.direction) {
      case "up":
        this.direction = "right";
        return this;
      case "right":
        this.direction = "down";
        return this;
      case "down":
        this.direction = "left";
        return this;
      case "left":
        this.direction = "up";
        return this;
      default:
        return this;
    }
  }

  moveForward() {
    switch (this.direction) {
      case "up":
        return new Position(this.r - 1, this.c, this.direction);
      case "right":
        return new Position(this.r, this.c + 1, this.direction);
      case "down":
        return new Position(this.r + 1, this.c, this.direction);
      case "left":
        return new Position(this.r, this.c - 1, this.direction);
      default:
        return this;
    }
  }

  getString() {
    return `${this.r},${this.c}`;
  }

  getStringWithDir() {
    return `${this.r},${this.c}${this.direction}`;
  }
}
const processData = (data) => {
  const rows = data.split("\n");
  const maze = rows.map((row) => row.split(""));
  for (let r = 0; r < maze.length; r++) {
    for (let c = 0; c < maze[r].length; c++) {
      if (maze[r][c] === "^") {
        return {
          maze,
          startPos: new Position(r, c, "up"),
        };
      }
    }
  }
  return {};
};
const isValidPosition = (maze, position) => {
  return (
    position.r >= 0 &&
    position.r < maze.length &&
    position.c >= 0 &&
    position.c < maze[0].length
  );
};
const isObstacle = (maze, pos, addedObs) => {
  return (
    maze[pos.r][pos.c] === "#" ||
    (addedObs !== undefined && pos.getString() === addedObs.getString())
  );
};
const part1 = (data) => {
  const { maze, startPos } = processData(data);
  // set of 'r,c'
  const distinctPos = new Set();

  let currPos = startPos;
  while (isValidPosition(maze, currPos)) {
    distinctPos.add(currPos.getString());
    // next position
    const nextPos = currPos.moveForward();
    if (isValidPosition(maze, nextPos) && isObstacle(maze, nextPos)) {
      currPos.turnRight();
    } else {
      currPos = nextPos;
    }
  }
  return distinctPos.size;
};

const part2 = (data) => {
  let count = 0;
  const { maze, startPos } = processData(data);

  for (let i = 0; i < maze.length; i++) {
    for (let j = 0; j < maze[0].length; j++) {
      startPos.direction = "up";
      const addObs = new Position(i, j);
      const distinctStates = new Set();
      let hasCycle = false;
      if (!isObstacle(maze, addObs) && !addObs.isEqual(startPos)) {
        let currPos = startPos;

        while (isValidPosition(maze, currPos)) {
          if (distinctStates.has(currPos.getStringWithDir())) {
            // cycle
            hasCycle = true;
            break;
          }
          distinctStates.add(currPos.getStringWithDir());

          // next position
          const nextPos = currPos.moveForward();

          if (
            isValidPosition(maze, nextPos) &&
            isObstacle(maze, nextPos, addObs)
          ) {
            currPos.turnRight();
          } else {
            currPos = nextPos;
          }
        }

        if (hasCycle) {
          count++;
        }
      }
    }
  }
  return count;
};
console.log(part2(test));

const test = `....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...`;

const puzzle = `..................#................................................................#........#.....................................
...#...........#...................................................#........................................#.................#...
...................................#................#.#...............#.................................................#.........
.....#......#................#.....................................................................#..........#........#......#...
............................................................................................#.....................#...............
.....................#..##...#........................#.................#.......................#..#.........#.......#...#......#.
............##....................................##..................#...............................#....#......................
.............#............#.#..#.......#...........#..............#...............#.....#.........................................
....................#..........##.........#.........#................#............................................................
....#.......#................................................................#...#.#..........................................#.#.
..#..............#.....................................#..........#.#....#..............#..................#.#............#.......
.#.......#.........................#........................#..#.....#............................................................
........#...#......................#...........#......................................#....................#......................
.............................#..............#........##....#....................#......#....................#............#......#.
..............#..............#............#.......................##....#..........................................#.........#....
.............#............#..........#..........#...#.....................................................#.......................
..#........#.....#..........................................#................................................#...#.#...#..........
........#.....................#...#..#......#.........................................................#.....##.........#..........
..............................................................................................#...#...............................
..#.......................#..........................#......#...................................................................#.
.......#.........................#..............#.........#.............#.......................................#...#.............
..................#.................#.......................#....................#....................................#...........
...#...#.......#......##.#...............#....#..............#..........................................#....#..#.................
#................................#.......#.....#.......#.............#..................#........#................................
...........#..................................#.......................................................................#.#..#......
.......#........#.........................................#..........................#...........................#.....#..........
................#..#.....................#..#...........................#...........................................#.............
#...#.......................#................................................#................#................................#..
..........#...........................#.......#............................................................................#.....#
..................................#............................................................#..................................
......................#........#.............#....#.....#.......#..........................#..........................#...........
...........................##.................#.............#........................#...#..................#.....................
.............................................................................................................#....#..........#....
................#...................................#...........#..........#....................#............................#....
........#....#................................................#................##..#..................................#...........
...........#....................................................#...#.#......#....................................................
.......................#.........................................................^....................................#...........
..........................#.............##..#........#.#....#.......#....................#...........#.........#.....#............
........#...........................#..#..........................................................#...............................
....#....................................#....#.........................................#.........#...............................
...............#...................................#.....#.................................#....................................#.
......#...............................................................#.............................#........................#....
.........................#.....#.........................#.#...............#.........#.....#..................#..#.........#......
.........................................................#......#........##.......................#...#......#................#...
.......................................#.....#.................................#..................................................
..................#..................................#..........................................................................#.
...................#....#.........#.......#................#....................#.........................#......#.....#..#.......
................................#..............................................................................#....#.............
.....................#.#.............#.................#..........#.......#.........................................#.............
......#....................#....................................................................#...#.............................
........#........#...........#.##.............#........................#............#..............#.........#....#........#......
........................#.................................................................#.......................................
............................................................#.....#....................#............#.....#....#............#.....
...........#............#....#........................................................##............#..............#..............
...........#...........#.....#..............#..............##....#........#......#................................................
..#................................................................................#......................#......#................
....................#.........#......................#.............................#.......#.......................#.............#
..#...#....#......................................................................................................#...............
...........#................................................................................#...............................#.....
....................................#............#..........#.........................#..................................#.......#
...................#......#...................#............#......#........#................#.............#...........#.........#.
........................#..................................#........#..................#..........................................
............#..#...........#..................##....................#...........................................#.................
.......................................................................................#.....#............#.......................
...............................................#....#................................#..#..........................#..#...........
..............#..#.....#.........#....................#.......#..#..............#...............................#.....#...........
..........#............................#..........................................................................................
........................................#........#........................................................#.#.....................
#................#......................#..................................................................................#......
...............................................................................#................................#.................
...................................................................................................................#.#........#...
#........................................................................#......................................#.#...............
...#......#............#...................#.............#........#..........................................#......#.............
..............##....#...................................................#......................#..................................
...............#........................................................................#...........#...#.#.......................
..........#.#.....#................................#...........#........#.......#.................................................
#....................#......................................................................................#.....................
..............#...##...........................................#.............#.......#..................#..............#..........
.#.............................................#..............................................................................#...
...#................................#............................................#............................#...................
..............................#......................................................#..........................................#.
...................#.....................................#..................................#......#..............................
....#.#..........##.............#.......#........................##..........#.................#..................................
#..#................#........##....................................................................................#..............
........#...#.........................................................................#...........................................
......................................................#....#...................#..#.................................#.............
........#...............#........#..............................................#............................#....................
...#..............................#.........................................##.......................................#....#.......
...#................#..............#.......#......................................................................................
........#..................#.............................................................#...........................#....#.......
......................#.#..........#.......#..................................#..#...#............#...............#...............
.....#..................#....#..#......#.......................#.....................................................#............
.....#................................#.........................#..................#.#..........#...#............#.....#..........
....#...................#....#.#.........#........#..................................................................#....#..#....
........#...............#......................................#........#..............................#..........................
....#...#.#.....#..............#..................#..........#...#..#......................#...#..........#......................#
...........#...................................................................................................#................#.
.................................##..............#.............................#...............................#..................
...........#.................#.............##...................................#.......................#.................##......
.....#..................#......#........#.................................................#..#........................#..#........
......#.......#......................................................................#.#.........#....#...........................
..................#.#........................#......#................................................................#......#.....
.....................#............#...................#.....#....................................#.......#..........#.......#.....
#.............................#...............................#...#...............................................................
..##.........#........#......................................#.....................#...#.............#............#..#............
..........#.....................#..#....................#...#....................#....................#.....................#.....
...........#..........#...............#..#..........#..............................................#.#............................
............#...#...#.............#.........#.............................#...............#.......................................
.........#...........#...............................................................#............................................
.#..#.................................................................#............#.#.......................##...................
........##............#...................#................................#......................................................
............................................#..........................#..........................................................
#...................#...........#..............#...#............#.#........#.................#......#.............................
........#....................................#....................................................................................
...........#.........#..#...............#...........#.....##.#......#....##............#....#....#.#.........##.........#.........
..#......................#..........#.................#.................#......#.............................#........#...........
....................#.................#....#..............................#....#.............#....#....#.....................#....
............#.................#.................................#...............................#..#...........................#..
...................................................#.....#..............#.......#....................#.#..........................
..#.........##..#........#...................................................................................#............#.......
.....#..............................#......................................................................#........#.............
................................#........##.......#...............#..............#.......#...#.#........#.........................
..............................#.....................#.........................................#..................................#
...........#...................##.................#.................................#...............................#........#....
..............................#...##......#..................#...#................................#......#.......#...............#
.....................##......#......#.#.......#..............#......#.................#.........#...................#.............
..........................#................................#...........#..........................................................
...#.....#....................#.....................#...#.....#.............................#.#....#.....#.#.................#....
............................#...#........#......................................................................#.....#...........
............#..........##..................#.............................................................#.....#..#...............`;
